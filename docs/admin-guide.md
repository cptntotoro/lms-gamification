# Руководство администратора

Это руководство предназначено для:

- **Администраторов LMS** — настройка интеграции, мониторинг, управление типами событий
- **Преподавателей с правами админа** — настройка правил начисления для своих курсов
- **Технических специалистов** — интеграция webhook, отладка ошибок, анализ логов

## 1. Основные административные возможности

| Раздел                      | Путь в API                           | Что можно делать                                                        | Права доступа (план) |
|-----------------------------|--------------------------------------|-------------------------------------------------------------------------|----------------------|
| Пользователи                | `/api/admin/users`                   | Просмотр списка студентов, очков, уровней, детальная карточка + история | ROLE_ADMIN           |
| Типы событий (CRUD)         | `/api/admin/event-types`             | Создание, редактирование, деактивация типов событий                     | ROLE_ADMIN           |
| История транзакций студента | `/api/admin/users/{id}/transactions` | Полная история начислений конкретного студента                          | ROLE_ADMIN           |
| Обработка событий от LMS    | POST `/api/events`                   | Основной эндпоинт для начисления очков (webhook)                        | LMS / API-ключ       |

## 2. Настройка типов событий

### Где находится раздел

Админ-панель LMS → **Геймификация** → **Типы событий**  
API: `/api/admin/event-types`

### Поля типа события

| Поле             | Тип     | Описание                                                    | Обязательно | Изменяемо после создания |
|------------------|---------|-------------------------------------------------------------|-------------|--------------------------|
| `typeCode`       | String  | Уникальный код типа (латинские буквы, цифры, подчёркивания) | Да          | Нет                      |
| `displayName`    | String  | Название для отображения студентам                          | Да          | Да                       |
| `points`         | Integer | Количество очков за одно событие                            | Да          | Да                       |
| `maxDailyPoints` | Integer | Максимум очков в сутки по этому типу (null = без лимита)    | Нет         | Да                       |
| `active`         | Boolean | Включён ли тип сейчас (true/false)                          | Да          | Да                       |

### Как создать новый тип события

1. Перейдите в **Типы событий**
2. Нажмите **Создать**
3. Заполните поля (обязательно `typeCode` уникальный)
4. Сохраните

**Важно:**  
После создания `typeCode` изменить **нельзя** — это ключ интеграции с LMS.

### Как временно отключить тип события

1. Найдите нужный тип в списке
2. Нажмите **Редактировать**
3. Снимите галочку **Активно**
4. Сохраните

Начисления по этому типу прекратятся, но вся история сохранится.

## 3. Интеграция с LMS

### Настройка в LMS

1. В LMS найдите раздел **Вебхуки** / **Интеграции** / **События**
2. Добавьте новый webhook:

- **URL:** `https://ваш-домен/api/events`
- **Метод:** POST
- **Аутентификация:** (пока без, в будущем — API-ключ или Basic Auth)
- **События:** те активности, которые нужно геймифицировать (завершение теста, сдача задания, участие в вебинаре и т.д.)

### Формат запроса от LMS

```json
{
  "userId": "student-uuid-12345",
  "eventId": "unique-event-uuid-2026-02-23-001",
  "eventType": "quiz"
}
```

- userId — уникальный идентификатор студента в LMS
- eventId — уникальный ID события (чтобы избежать дублей)
- eventType — код типа события (должен совпадать с typeCode в системе)

### Возможные ответы от системы

Система всегда возвращает HTTP 200 OK с JSON-ответом в формате `LmsEventResponsetDto`.  
Возможные варианты:

- Успех

```json
{
  "status": "success",
  "userId": "student-uuid-12345",
  "eventId": "unique-event-uuid-...",
  "displayName": "Квиз",
  "pointsEarned": 100,
  "totalPoints": 1250,
  "levelUp": true,
  "pointsToNextLevel": 750,
  "transactionId": "uuid-транзакции",
  "processedAt": "2026-02-23T18:45:12Z"
}
```

- Дубликат

```json
{
  "status": "duplicate",
  "eventId": "unique-event-uuid-...",
  "message": "Событие уже обработано ранее"
}
```

- Ошибка (например, лимит)

```json
{
  "status": "error",
  "message": "Неизвестный или отключённый тип события: webinar"
}
```

### 4. Мониторинг и отладка

#### Где смотреть данные

- **Список всех студентов и их прогресс**  
  GET `/api/admin/users`  
  → показывает текущие очки, уровень, дату регистрации

- **Детали конкретного студента**  
  GET `/api/admin/users/{userId}`  
  → полная информация + ссылка на историю транзакций

- **История начислений студента**  
  GET `/api/admin/users/{userId}/transactions`  
  → все транзакции с фильтром по дате, типу события, пагинацией и сортировкой

- **Все типы событий**  
  GET `/api/admin/event-types`  
  → список с текущими настройками (очки, лимиты, active)

#### Как проверить, почему не начислились очки

1. Убедитесь, что событие отправляется из LMS  
   → Проверьте логи webhook'а в LMS (должен быть POST-запрос на `/api/events`)

2. Посмотрите ответ от сервера геймификации  
   → Должен быть 200 OK + JSON с `status`: `"success"`, `"duplicate"` или `"error"` + `message`

3. Найдите запись в логах сервера геймификации
    - Ищите строки с `eventId=...`
    - Ключевые фразы:
        - `Начало начисления очков`
        - `Дубликат события`
        - `Превышен дневной лимит`
        - `Не найден активный тип события`

4. Если ошибка — смотрите поле `message` в ответе или логи сервера

#### Типичные проблемы и решения

- **Событие не пришло на сервер**  
  → Проверьте настройки webhook в LMS (URL, метод, тело запроса)

- **Статус "duplicate"**  
  → LMS отправляет одно и то же событие несколько раз  
  → Исправьте логику в LMS (отправлять событие ровно один раз)

- **"Превышен дневной лимит"**  
  → Студент уже набрал максимум за сутки  
  → Увеличьте `maxDailyPoints` в настройках типа события или подождите следующие сутки

- **"Неизвестный или отключённый тип события"**  
  → `typeCode` не совпадает или тип деактивирован (`active = false`)  
  → Проверьте и исправьте в админке → Типы событий

- **500 Internal Server Error**  
  → Техническая проблема (БД недоступна, ошибка сервера и т.д.)  
  → Проверьте логи сервера геймификации и создайте issue

### 6. Рекомендации по безопасности и производительности

- **Защита админ-эндпоинтов**  
  В будущем добавить JWT / OAuth + аннотацию `@PreAuthorize("hasRole('ADMIN')")`

- **Ограничение частоты запросов**  
  Рекомендуется добавить rate-limiting на `/api/events`  
  Пример: 100 запросов в минуту на один IP  
  (реализовать через Spring Boot + Bucket4j или nginx)

- **Логирование**  
  В production включите уровень `INFO` для пакета `ru.misis.gamification`  
  Сохраняйте логи минимум 30 дней

- **Бэкапы**  
  Регулярно бэкапить БД, особенно таблицы:
    - `transactions` (история начислений)
    - `event_types` (настройки правил)

### 7. Техническая поддержка

- **Баг или ошибка** → создайте issue на GitHub:  
  https://github.com/cptntotoro/lms-gamification/issues

- **Предложение по улучшению** → issue с меткой `enhancement`

- **Где смотреть логи сервера**  
  В консоли приложени

Спасибо, что используете и развиваете наш модуль геймификации!  
Мы открыты к обратной связи и новым идеям.

**Разработано в рамках НИР**  
«Исследование архитектурных подходов и проектирование серверного модуля геймификации для интеграции с российскими LMS
платформами»