# API Reference

**Геймификация образовательного процесса в LMS**

**Версия API:** v1 (февраль 2026)  
**Базовый URL:** `https://your-domain/api`  
**Формат всех ответов:** JSON  
**Аутентификация:** Пока открытый доступ (в планах — API-ключ или JWT)  
**OpenAPI / Swagger:** [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)  
**OpenAPI JSON:** [http://localhost:8080/v3/api-docs](http://localhost:8080/v3/api-docs)

## Общие принципы

- Все пути в нижнем регистре с дефисами (`kebab-case`)
- Ресурсы во множественном числе (`users`, `event-types`)
- Админ-эндпоинты начинаются с `/admin`
- Все ответы возвращают HTTP 200 OK (даже при ошибках — статус в поле `status`)
- Ошибки возвращаются в теле ответа как `LmsEventResponsetDto` с `status: "error"` и `message`

## Основные эндпоинты

### Публичные (для виджета и студентов)

#### GET /users/{userId}/progress

Получить текущий прогресс пользователя для отображения в виджете.

**Параметры пути:**

- `userId` (string, required) — внешний ID студента из LMS

**Ответ (200 OK):**

```json
{
  "uuid": "550e8400-e29b-41d4-a716-446655440000",
  "userId": "student-12345",
  "totalPoints": 1250,
  "level": 5,
  "pointsToNextLevel": 750
}
```

### Возможные ошибки

- 200 OK + `status: "error"` → пользователь не найден или другие бизнес-ошибки

### События от LMS

**POST /events**  
Основной эндпоинт для начисления очков. LMS отправляет событие через webhook.

**Тело запроса** (`LmsEventRequestDto`):

```json
{
  "userId": "student-uuid-12345",
  "eventId": "unique-event-uuid-2026-02-23-001",
  "eventType": "quiz"
}
```

Ответ (всегда 200 OK):

- Успех

```json
{
  "status": "success",
  "userId": "student-uuid-12345",
  "eventId": "unique-event-uuid-...",
  "displayName": "Квиз",
  "pointsEarned": 100,
  "totalPoints": 1250,
  "levelUp": true,
  "pointsToNextLevel": 750,
  "transactionId": "uuid-транзакции",
  "processedAt": "2026-02-23T18:45:12Z"
}
```

- Дубликат

```json
{
  "status": "duplicate",
  "eventId": "unique-event-uuid-...",
  "message": "Событие уже обработано ранее"
}
```

- Ошибка (лимит, отключён тип и т.д.)

```json
{
  "status": "error",
  "message": "Превышен дневной лимит по типу Квиз"
}
```

**Важно:**  
`eventId` должен быть **уникальным** в рамках всей системы — повторная отправка одного и того же `eventId` вернёт статус
`"duplicate"`.

### Административные эндпоинты (`/api/admin`)

Все эндпоинты требуют прав администратора (в будущем — ROLE_ADMIN + JWT).

#### Пользователи

- **GET /admin/users**  
  Список всех пользователей (пагинация, фильтры по userId, уровню, очкам — в планах)

- **GET /admin/users/{userId}**  
  Детальная информация о пользователе + текущий прогресс

- **GET /admin/users/{userId}/transactions**  
  История всех транзакций пользователя (пагинация, сортировка по дате, фильтр по типу события)

#### Типы событий (CRUD)

- **GET /admin/event-types**  
  Список всех типов событий (пагинация)

- **GET /admin/event-types/{id}**  
  Получение одного типа события по UUID

- **POST /admin/event-types**  
  Создание нового типа события

  **Тело запроса:**

```json
{
  "typeCode": "quiz-advanced",
  "displayName": "Сложный квиз",
  "points": 150,
  "maxDailyPoints": 500,
  "active": true
}
```

- **PUT /admin/event-types/{id}**  
  Частичное обновление типа события  
  **Нельзя** менять `typeCode`

- **DELETE /admin/event-types/{id}**  
  Деактивация типа события (`active = false`)  
  Физическое удаление не поддерживается

### Коды ответов и статусы

| HTTP-код | Статус в JSON | Описание                                                             |
|----------|---------------|----------------------------------------------------------------------|
| 200      | `"success"`   | Очки успешно начислены                                               |
| 200      | `"duplicate"` | Событие уже обработано (дубликат по eventId)                         |
| 200      | `"error"`     | Бизнес-ошибка (лимит, отключён тип и т.д.) — смотрите поле `message` |
| 400      | —             | Ошибка валидации запроса (в будущем)                                 |
| 500      | —             | Техническая ошибка сервера (неожиданное исключение)                  |

### Рекомендации по интеграции

- Используйте **уникальный** `eventId` (рекомендуется UUID или комбинация LMS event ID + timestamp)
- Обрабатывайте ответы с `status: "duplicate"` и `"error"` — **не повторяйте** запрос
- Тестируйте webhook на staging-среде перед продакшеном
- Логируйте все ответы от `/api/events` в LMS для отладки

### Техническая поддержка

- **Баг/ошибка** → создайте issue на GitHub:  
  https://github.com/cptntotoro/lms-gamification/issues

- **Предложение по улучшению** → issue с меткой `enhancement`

**Разработано в рамках НИР**  
«Исследование архитектурных подходов и проектирование серверного модуля геймификации для интеграции с российскими LMS
платформами»